<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¯¸ì¹œì œìœ¡ - ì‚¬ìš©ì í–‰ë™ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    
    <style>
      :root {
        --primary: #0ea5e9;
        --primary-dark: #0284c7;
        --bg: #f8fafc;
        --card: #ffffff;
        --border: #e2e8f0;
        --text: #1e293b;
        --text-muted: #64748b;
        --success: #22c55e;
        --warning: #f59e0b;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        height: 100vh;
        overflow: hidden;
      }

      .dashboard-container {
        display: grid;
        grid-template-columns: 350px 1fr 350px;
        gap: 20px;
        height: 100vh;
        padding: 20px;
      }

      /* ì™¼ìª½: ë°©ë¬¸ì ëª©ë¡ */
      .visitor-list {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .visitor-list-header {
        padding: 20px;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        color: white;
        border-bottom: 1px solid var(--border);
      }

      .visitor-list-header h2 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      .visitor-list-header .subtitle {
        font-size: 14px;
        opacity: 0.9;
      }

      .visitor-list-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
      }

      .visitor-item {
        padding: 16px;
        border: 2px solid transparent;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg);
      }

      .visitor-item:hover {
        background: #e0f2fe;
        border-color: var(--primary);
      }

      .visitor-item.active {
        background: #dbeafe;
        border-color: var(--primary);
      }

      .visitor-item-time {
        font-weight: 600;
        font-size: 16px;
        color: var(--text);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .visitor-item-info {
        font-size: 13px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 6px;
      }

      .visitor-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-qr {
        background: #dcfce7;
        color: #166534;
      }

      .badge-normal {
        background: #e0f2fe;
        color: #0c4a6e;
      }

      .badge-mobile {
        background: #fef3c7;
        color: #92400e;
      }

      .badge-pc {
        background: #e0e7ff;
        color: #3730a3;
      }

      .action-count {
        font-weight: 600;
        color: var(--primary);
      }

      /* ê°€ìš´ë°: ìƒì„¸ í–‰ë™ íƒ€ì„ë¼ì¸ */
      .timeline-container {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* ì˜¤ë¥¸ìª½: í†µê³„ ì •ë³´ */
      .stats-container {
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .stats-header {
        padding: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border-bottom: 1px solid var(--border);
      }

      .stats-header h2 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      .stats-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8fafc;
      }

      .stats-section {
        background: white;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stats-section h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text);
        padding-bottom: 8px;
        border-bottom: 2px solid var(--border);
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-label {
        font-size: 14px;
        color: var(--text-muted);
      }

      .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary);
      }

      .stat-value-large {
        font-size: 24px;
      }

      .stats-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }

      .timeline-header {
        padding: 20px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        border-bottom: 1px solid var(--border);
      }

      .timeline-header h2 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      .timeline-header .session-info {
        font-size: 14px;
        opacity: 0.9;
      }

      .timeline-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8fafc;
      }

      .timeline-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-muted);
        font-size: 16px;
        text-align: center;
        flex-direction: column;
        gap: 12px;
      }

      .timeline-item {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .timeline-line {
        width: 3px;
        background: linear-gradient(to bottom, var(--primary), #cbd5e1);
        border-radius: 2px;
        flex-shrink: 0;
      }

      .timeline-dot {
        width: 12px;
        height: 12px;
        background: var(--primary);
        border: 3px solid white;
        border-radius: 50%;
        margin-top: 4px;
        margin-left: -4.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .timeline-content-item {
        flex: 1;
        background: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 3px solid var(--primary);
      }

      .timeline-time {
        font-weight: 600;
        color: var(--primary);
        font-size: 14px;
        margin-bottom: 6px;
      }

      .timeline-action {
        font-size: 16px;
        color: var(--text);
        margin-bottom: 4px;
      }

      .timeline-target {
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .action-icon {
        display: inline-block;
        margin-right: 6px;
      }

      /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
      .visitor-list-content::-webkit-scrollbar,
      .timeline-content::-webkit-scrollbar,
      .stats-content::-webkit-scrollbar {
        width: 6px;
      }

      .visitor-list-content::-webkit-scrollbar-track,
      .timeline-content::-webkit-scrollbar-track,
      .stats-content::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      .visitor-list-content::-webkit-scrollbar-thumb,
      .timeline-content::-webkit-scrollbar-thumb,
      .stats-content::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      .visitor-list-content::-webkit-scrollbar-thumb:hover,
      .timeline-content::-webkit-scrollbar-thumb:hover,
      .stats-content::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      @media (max-width: 1400px) {
        .dashboard-container {
          grid-template-columns: 300px 1fr;
        }
        .stats-container {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- ì™¼ìª½: ë°©ë¬¸ì ëª©ë¡ -->
      <div class="visitor-list">
        <div class="visitor-list-header">
          <h2>ğŸ“Š ì˜¤ëŠ˜ì˜ ë°©ë¬¸ì</h2>
          <div class="subtitle" id="visitorCount">0ëª…</div>
        </div>
        <div class="visitor-list-content" id="visitorList">
          <!-- ë°©ë¬¸ì ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
      </div>

      <!-- ê°€ìš´ë°: ìƒì„¸ í–‰ë™ íƒ€ì„ë¼ì¸ -->
      <div class="timeline-container">
        <div class="timeline-header">
          <h2>ğŸ“‹ í–‰ë™ íƒ€ì„ë¼ì¸</h2>
          <div class="session-info" id="sessionInfo">ì™¼ìª½ì—ì„œ ë°©ë¬¸ìë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <div class="timeline-content" id="timelineContent">
          <div class="timeline-empty">
            <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‘ˆ</div>
            <div>ì™¼ìª½ì—ì„œ ë°©ë¬¸ìë¥¼ ì„ íƒí•˜ë©´<br>ìƒì„¸ í–‰ë™ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: í†µê³„ ì •ë³´ -->
      <div class="stats-container">
        <div class="stats-header">
          <h2>ğŸ“Š í†µê³„ ìš”ì•½</h2>
          <div class="subtitle" id="statsDate">ì˜¤ëŠ˜</div>
        </div>
        <div class="stats-content" id="statsContent">
          <div class="stats-empty">í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
      import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: "AIzaSyCYw0ENrKZoV8r1crAK9Ej4Ac15UgI9bqs",
        authDomain: "mcjy-77dfa.firebaseapp.com",
        projectId: "mcjy-77dfa",
        storageBucket: "mcjy-77dfa.firebasestorage.app",
        messagingSenderId: "408069861706",
        appId: "1:408069861706:web:a3ef90bcc35ccc2c5511b3",
        measurementId: "G-J7SLHLP7PH"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let visitors = [];
      let selectedVisitorId = null;
      let dailyStats = null;
      let menuStats = null;
      let clickStats = null;

      // ì‹œê°„ í¬ë§·íŒ…
      function formatTime(timestamp) {
        if (!timestamp) return 'ì‹œê°„ ì—†ìŒ';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
      }

      function formatFullTime(timestamp) {
        if (!timestamp) return 'ì‹œê°„ ì—†ìŒ';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      }

      // ë°©ë¬¸ì ëª©ë¡ ë Œë”ë§
      function renderVisitorList() {
        const container = document.getElementById('visitorList');
        const countEl = document.getElementById('visitorCount');
        
        countEl.textContent = `${visitors.length}ëª…`;

        if (visitors.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">ë°©ë¬¸ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }

        container.innerHTML = visitors.map(visitor => {
          const time = formatTime(visitor.entryTime);
          const actionCount = visitor.actions?.length || 0;
          const isActive = selectedVisitorId === visitor.id;

          return `
            <div class="visitor-item ${isActive ? 'active' : ''}" data-id="${visitor.id}" onclick="selectVisitor('${visitor.id}')">
              <div class="visitor-item-time">
                ğŸ•’ ${time}
              </div>
              <div class="visitor-item-info">
                <span class="visitor-badge badge-${visitor.type.toLowerCase()}">${visitor.type}</span>
                <span class="visitor-badge badge-${visitor.device.toLowerCase()}">${visitor.device}</span>
                <span class="action-count">í–‰ë™ ${actionCount}ê±´</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // íƒ€ì„ë¼ì¸ ë Œë”ë§
      function renderTimeline(visitor) {
        const container = document.getElementById('timelineContent');
        const infoEl = document.getElementById('sessionInfo');

        if (!visitor) {
          container.innerHTML = `
            <div class="timeline-empty">
              <div style="font-size: 48px; margin-bottom: 12px;">ğŸ‘ˆ</div>
              <div>ì™¼ìª½ì—ì„œ ë°©ë¬¸ìë¥¼ ì„ íƒí•˜ë©´<br>ìƒì„¸ í–‰ë™ ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
            </div>
          `;
          infoEl.textContent = 'ì™¼ìª½ì—ì„œ ë°©ë¬¸ìë¥¼ ì„ íƒí•˜ì„¸ìš”';
          return;
        }

        const entryTime = formatFullTime(visitor.entryTime);
        const type = visitor.type;
        const device = visitor.device;
        const actions = visitor.actions || [];

        infoEl.textContent = `ì…ì¥: ${entryTime} | ${type} ì ‘ì† | ${device}`;

        if (actions.length === 0) {
          container.innerHTML = `
            <div class="timeline-empty">
              <div style="font-size: 48px; margin-bottom: 12px;">ğŸ“­</div>
              <div>ì•„ì§ í–‰ë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="timeline-item">
            <div style="position: relative;">
              <div class="timeline-line"></div>
              <div class="timeline-dot"></div>
            </div>
            <div class="timeline-content-item">
              <div class="timeline-time">â¬‡ï¸ ${entryTime}</div>
              <div class="timeline-action">ì‚¬ì´íŠ¸ ì…ì¥ (${type})</div>
            </div>
          </div>
          ${actions.map(action => `
            <div class="timeline-item">
              <div style="position: relative;">
                <div class="timeline-line"></div>
                <div class="timeline-dot"></div>
              </div>
              <div class="timeline-content-item">
                <div class="timeline-time">â¬‡ï¸ ${action.time}</div>
                <div class="timeline-action">${action.action}</div>
                <div class="timeline-target">${action.target ? `[${action.target}]` : ''}</div>
              </div>
            </div>
          `).join('')}
        `;
      }

      // ë°©ë¬¸ì ì„ íƒ
      window.selectVisitor = function(visitorId) {
        selectedVisitorId = visitorId;
        const visitor = visitors.find(v => v.id === visitorId);
        renderVisitorList();
        renderTimeline(visitor);
      };

      // í†µê³„ ë°ì´í„° ë¡œë“œ
      async function loadStats() {
        try {
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          
          // ì˜¤ëŠ˜ ë°©ë¬¸ í†µê³„
          const dailyStatsRef = doc(db, 'daily_stats', todayStr);
          const dailyStatsSnap = await getDoc(dailyStatsRef);
          dailyStats = dailyStatsSnap.exists() ? dailyStatsSnap.data() : null;

          // ë©”ë‰´ í´ë¦­ í†µê³„
          const menuStatsRef = doc(db, 'menu_stats', 'clicks');
          const menuStatsSnap = await getDoc(menuStatsRef);
          menuStats = menuStatsSnap.exists() ? menuStatsSnap.data() : null;

          // ë²„íŠ¼ í´ë¦­ í†µê³„
          const clickStatsRef = doc(db, 'click_stats', 'main_actions');
          const clickStatsSnap = await getDoc(clickStatsRef);
          clickStats = clickStatsSnap.exists() ? clickStatsSnap.data() : null;

          renderStats();
        } catch (error) {
          console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
        }
      }

      // í†µê³„ ë Œë”ë§
      function renderStats() {
        const container = document.getElementById('statsContent');
        const dateEl = document.getElementById('statsDate');
        const today = new Date().toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' });
        dateEl.textContent = today;

        let html = '';

        // ì˜¤ëŠ˜ ë°©ë¬¸ í†µê³„
        html += `
          <div class="stats-section">
            <h3>ğŸ“ˆ ì˜¤ëŠ˜ì˜ ë°©ë¬¸</h3>
            ${dailyStats ? `
              <div class="stat-item">
                <span class="stat-label">QR ì½”ë“œ ìœ ì…</span>
                <span class="stat-value">${dailyStats.qr_count || 0}ëª…</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ì¼ë°˜ ìœ ì…</span>
                <span class="stat-value">${dailyStats.general_count || 0}ëª…</span>
              </div>
              <div class="stat-item" style="border-top: 2px solid var(--border); margin-top: 10px; padding-top: 15px;">
                <span class="stat-label">ì´ ë°©ë¬¸ì</span>
                <span class="stat-value stat-value-large">${(dailyStats.qr_count || 0) + (dailyStats.general_count || 0)}ëª…</span>
              </div>
            ` : `
              <div class="stats-empty">ì˜¤ëŠ˜ ë°©ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            `}
          </div>
        `;

        // ë²„íŠ¼ í´ë¦­ í†µê³„
        html += `
          <div class="stats-section">
            <h3>ğŸ”˜ ë²„íŠ¼ í´ë¦­</h3>
            ${clickStats ? Object.entries(clickStats)
              .sort((a, b) => (b[1] || 0) - (a[1] || 0))
              .map(([key, value]) => {
                const labels = {
                  ttaengyo: 'ë•¡ê²¨ìš”',
                  baemin: 'ë°°ë‹¬ì˜ë¯¼ì¡±',
                  coupang: 'ì¿ íŒ¡ì´ì¸ ',
                  yogiyo: 'ìš”ê¸°ìš”',
                  public_delivery: 'ë°°ë‹¬íŠ¹ê¸‰',
                  phone_call: 'ì „í™”í•˜ê¸°'
                };
                return `
                  <div class="stat-item">
                    <span class="stat-label">${labels[key] || key}</span>
                    <span class="stat-value">${value || 0}íšŒ</span>
                  </div>
                `;
              }).join('') : `
              <div class="stats-empty">ë²„íŠ¼ í´ë¦­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            `}
          </div>
        `;

        // ë©”ë‰´ í´ë¦­ í†µê³„
        html += `
          <div class="stats-section">
            <h3>ğŸ½ï¸ ì¸ê¸° ë©”ë‰´</h3>
            ${menuStats ? Object.entries(menuStats)
              .sort((a, b) => (b[1] || 0) - (a[1] || 0))
              .slice(0, 10)
              .map(([menuName, count]) => `
                <div class="stat-item">
                  <span class="stat-label" style="font-size: 13px;">${menuName}</span>
                  <span class="stat-value" style="font-size: 16px;">${count || 0}íšŒ</span>
                </div>
              `).join('') : `
              <div class="stats-empty">ë©”ë‰´ í´ë¦­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            `}
          </div>
        `;

        container.innerHTML = html;
      }

      // ì‹¤ì‹œê°„ ë°ì´í„° êµ¬ë…
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const q = query(
        collection(db, 'daily_visits'),
        orderBy('entryTime', 'desc')
      );

      onSnapshot(q, (snapshot) => {
        visitors = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // ì˜¤ëŠ˜ ë‚ ì§œë§Œ í•„í„°ë§
        visitors = visitors.filter(visitor => {
          if (!visitor.entryTime) return false;
          const entryDate = visitor.entryTime.toDate ? visitor.entryTime.toDate() : new Date(visitor.entryTime);
          return entryDate >= today;
        });

        renderVisitorList();

        // ì„ íƒëœ ë°©ë¬¸ìê°€ ìˆìœ¼ë©´ íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
        if (selectedVisitorId) {
          const visitor = visitors.find(v => v.id === selectedVisitorId);
          if (visitor) {
            renderTimeline(visitor);
          }
        }
      }, (error) => {
        console.error('ë°ì´í„° êµ¬ë… ì˜¤ë¥˜:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });

      // í†µê³„ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
      loadStats();
      setInterval(loadStats, 30000); // 30ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    </script>
  </body>
</html>

